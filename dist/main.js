(()=>{"use strict";var r={334:r=>{r.exports=require("dotenv")}},o={};function e(t){var i=o[t];if(void 0!==i)return i.exports;var a=o[t]={exports:{}};return r[t](a,a.exports,e),a.exports}e.n=r=>{var o=r&&r.__esModule?()=>r.default:()=>r;return e.d(o,{a:o}),o},e.d=(r,o)=>{for(var t in o)e.o(o,t)&&!e.o(r,t)&&Object.defineProperty(r,t,{enumerable:!0,get:o[t]})},e.o=(r,o)=>Object.prototype.hasOwnProperty.call(r,o),(()=>{const r=require("tslib"),o=require("http");var t=e.n(o);const i=require("throng");var a=e.n(i);const n=require("bunyan");var d=e.n(n);e(334).config();const u="0.0.1",s=(r,o)=>d().createLogger({name:`${r}:${o}`}),c={development:{PORT:process.env.PORT,link:"http://localhost:5000/",servidorSQL:process.env.SERVIDOR_SQL,usuarioSQL:process.env.USUARIO_SQL,passwordSQL:process.env.PASSWORD_SQL,baseDeDatosSQL:process.env.BASE_DE_DATOS_NAME,jwtKey:process.env.JWT_TOKEN_KEY,tokenSUNAT:process.env.SUNAT_TOKEN,log:()=>s("DESARROLLO",u)},production:{PORT:process.env.PORT,link:"http://localhost:5000/",servidorSQL:process.env.SERVIDOR_SQL,usuarioSQL:process.env.USUARIO_SQL,passwordSQL:process.env.PASSWORD_SQL,baseDeDatosSQL:process.env.BASE_DE_DATOS_NAME,jwtKey:process.env.JWT_TOKEN_KEY,tokenSUNAT:process.env.SUNAT_TOKEN,log:()=>s("PRODUCCION",u)}},l=require("compression");var p=e.n(l);const b=require("cookie-parser");var _=e.n(b);const y=require("express");var v=e.n(y);const m=require("helmet");var g=e.n(m);const h=require("cors");var f=e.n(h);const M=require("mssql");var w=e.n(M);const C="get_usuarios",T=(r,o,e,t)=>(e.log().error(r),o.status(t).json({error:r.message})),E=require("bcrypt");var D=e.n(E);const I=require("jsonwebtoken");var S=e.n(I);const x=require("axios");var j=e.n(x);const U=["M","S","U","D"],q=new Error("Este Usuario No Existe"),N=(o,e)=>({registrar:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=t.body.usuario,a=t.body.infoContacto,n=t.body.personaNatural;if(!A(r,a,n)){const r=new Error("Datos incorrectos");return V(r,i,o,400)}const d=yield D().hash(r.contrasena_enviada,10),u=yield e.request().input("codDistrito",w().VarChar(6),a.codDistrito).input("esAdmin",w().Bit,r.esAdmin).input("celular",w().VarChar(15),a.celular).input("direccion_linea_uno",w().VarChar(100),a.direccion_linea_uno).input("direccion_linea_dos",w().VarChar(100),a.direccion_linea_dos).input("codigo_postal",w().VarChar(15),a.codigo_postal).input("correo_electronico",w().NVarChar(255),a.correo_electronico).input("DNI",w().Char(8),n.DNI).input("nombre",w().VarChar(60),n.nombre).input("apellido_uno",w().VarChar(60),n.apellido_uno).input("apellido_dos",w().VarChar(60),n.apellido_dos).input("fecha_nacimiento",w().Date,n.fecha_nacimiento).input("username",w().VarChar(20),r.username).input("contrasena",w().Char(60),d).output("codUsuario",w().Int).output("error",w().Int).output("errorMSG",w().VarChar(250)).execute("insertar_usuario");if(0===u.output.codUsuario){const r=new Error("Usuario o usuario con este DNI ya existe");return V(r,i,o,400)}if(u.output.error){const r=new Error(2627===u.output.error?"Datos De Contacto Multiplicados":`Error ${u.output.error}`);return V(r,i,o,400)}const s=u.recordset[0];return s.contrasena=void 0,i.json(s)}catch(r){return V(r,i,o,500)}})),getUsuario:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=t.body.tipoDeBusqueda||0;if(!L(r)){const r=new Error("Tipo De Busqueda Invalido");return V(r,i,o,400)}const a=yield e.request().input("tipoDeBusqueda",w().Char(1),U[r]).input("codUsuario",w().Int,t.body.codUsuario||null).input("username",w().VarChar(20),t.body.username||null).input("DNI",w().Char(8),t.body.DNI||null).execute(C);if(0===a.recordset.length){const r=new Error("No se encontro el usuario");return V(r,i,o,404)}i.json(1===a.recordset.length?a.recordset[0]:a.recordset)}catch(r){return V(r,i,o,500)}})),darDeAltaUsuario:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!t.body.codUsuario)return V(q,i,o,500);const r=t.body.codUsuario,a=t.body.codTrabajo,n=yield e.request().input("codUsuario",w().Int,r).input("dado_alta",w().Bit,!0).input("codTrabajo",w().TinyInt,a).input("esAdmin",w().Bit,t.body.esAdmin).input("fecha_entrada",w().Date,t.body.fecha_entrada||new Date).output("error",w().Int).output("errorMSG",w().VarChar(250)).execute("dar_de_alta_usuario");if(n.output.error){const r=new Error(2627===n.output.error?"Datos Multiplicados":`Error ${n.output.errorMSG}`);return V(r,i,o,400)}return 1!==n.recordset.length?V(q,i,o,500):i.json(n.recordset[0])}catch(r){return V(r,i,o,500)}})),darDeBajaUsuario:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!t.body.codUsuario)return V(q,i,o,500);const r=t.body.codUsuario;return(yield e.request().input("codUsuario",w().Int,r).output("updated",w().Bit).execute("dar_de_baja_usuario")).output.updated?i.json({mensaje:"Usuario dado de baja"}):V(q,i,o,500)}catch(r){return V(r,i,o,500)}})),getDatosCompletosUsuario:(t,i,a)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!t.body.codUsuario)return V(q,i,o,500);const r=t.body.codUsuario,n=yield e.request().input("codUsuario",w().Int,r).execute("get_usuario_completo");if(1!==n.recordset.length)return V(q,i,o,500);const d=n.recordset[0];i.locals.datosCompletosUsuario=d,a()}catch(r){return V(r,i,o,500)}})),enviarTokenLogin:(e,t)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=t.locals.usuario;r.contrasena_enviada=void 0,r.contrasena=void 0;const e=S().sign({aud:`${r.codUsuario} ${r.username} ${r.esAdmin?"Administrador":"Personal"}`,_id:r.codUsuario},o.jwtKey);return t.json({usuario:r,loginToken:e})}catch(r){return V(r,t,o,500)}})),validarDNI:(e,t)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{console.log(e.body.dni);const r=yield j().post("https://api.migo.pe/api/v1/dni",{token:o.tokenSUNAT,dni:e.body.dni});t.json(r.data)}catch(r){return r.response.status?t.json({success:!1}):V(r,t,o,500)}})),eliminarUsuario:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!t.body.codUsuario)return V(q,i,o,500);if(0===(yield e.request().input("codUsuario",w().Int,t.body.codUsuario).output("error",w().Int).output("errorMSG",w().VarChar(200)).execute("eliminar_usuario")).rowsAffected.length)return V(q,i,o,500);i.json({mensaje:"Usuario eliminado"})}catch(r){return V(r,i,o,500)}})),comprobarUsuarioExisteLogin:(t,i,a)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!t.body.username){const r=new Error("Usuario Invalido");return V(r,i,o,401)}const r=yield e.request().input("username",w().VarChar(20),t.body.username).execute("comprobar_usuario_login");if(1!==r.recordset.length){const r=new Error("El usuario no existe");return V(r,i,o,401)}if(!1===r.recordset[0].dado_alta){const r=new Error("El usuario no ha sido dado de alta");return V(r,i,o,401)}i.locals.usuario=r.recordset[0],console.log(i.locals.usuario.contrasena.toString()),a()}catch(r){return V(r,i,o,500)}})),comprobarContrasena:(e,t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=t.locals.usuario;if(e.body.contrasena_enviada.length<6){const r=new Error("Contraseña Incorrecta");return V(r,t,o,403)}const a=r.contrasena.toString();if(!(yield D().compare(e.body.contrasena_enviada,a))){const r=new Error("Contraseña Incorrecta");return V(r,t,o,403)}i()}catch(r){return V(r,t,o,500)}})),reHabilitarUsuario:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!t.body.codUsuario)return V(q,i,o,500);const r=t.body.codUsuario;return(yield e.request().input("codUsuario",w().Int,r).output("updated",w().Bit).execute("re_habilitar_usuario")).output.updated?i.json({mensaje:"Usuario Rehabilidado"}):V(q,i,o,500)}catch(r){return V(r,i,o,500)}})),usuarioExiste:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{console.log("d");const r=yield e.request().input("tipoDeBusqueda",w().Char(1),"U").input("codUsuario",w().Int,null).input("username",w().VarChar(20),t.body.username).input("DNI",w().Char(8),null).execute(C);i.json(0===r.recordset.length?{existe:!1}:{existe:!0})}catch(r){return console.log(r),V(r,i,o,500)}})),loginRequired:(e,t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!t.locals.usuario){const r=new Error("Contenido protegido");return V(r,t,o,401)}i()}catch(r){return V(r,t,o,500)}})),adminLoginRequired:(e,t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!t.locals.usuario||"Administrador"!==t.locals.usuario.aud.split(" ")[2]){const r=new Error("Contenido protegido");return V(r,t,o,401)}i()}catch(r){return V(r,t,o,500)}}))}),V=(r,o,e,t)=>(e.log().error(r),o.status(t).json({error:r.message})),A=(r,o,e)=>!!(O(r)&&R(o)&&P(e)),O=r=>{const o=/^[0-9a-zA-Z]+$/;return!((r.username.length>20||r.username.length<3)&&!r.username.match(o)||!r.contrasena_enviada.match(o))},R=r=>!(!r.celular.match(/^[0-9]+$/)&&r.celular.length>15||r.correo_electronico.length>255||r.direccion_linea_uno.length>100||r.direccion_linea_dos&&r.direccion_linea_dos.length>100),P=r=>8===r.DNI.length||!r.DNI.match(/^[0-9]+$/),L=r=>r>=0&&U.length>r,$=r=>r.length<50,B=(r,o,e,t)=>(e.log().error(r),o.status(t).json({error:r.message})),Q=(...r)=>{for(let o=0;o<r.length;o++)if(null===r[o]||void 0===r[o]||""===r[o])return!1;return!0};class F{constructor(r,o,e,t){this.configuracion={server:r,database:t,user:o,password:e,options:{encrypt:!0,trustServerCertificate:!1}}}get getConfig(){return this.configuracion}}const k=require("morgan");var K=e.n(k);const z=o=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){const e=new F(o.servidorSQL,o.usuarioSQL,o.passwordSQL,o.baseDeDatosSQL).getConfig,t=v()();t.use(g()()),t.use(p()()),t.use(_()()),t.use(f()()),t.use(K()(":method :url")),t.use(v().json()),t.use(v().urlencoded({extended:!0})),t.use(((r,e,t)=>{if(r.headers&&r.headers.authorization&&"JWT"===r.headers.authorization.split(" ")[0]){const i=r.headers.authorization;S().verify(i.split(" ")[1],o.jwtKey,{audience:`${i.split(" ")[2]} ${i.split(" ")[3]} ${i.split(" ")[4]}`},((r,o)=>{if(console.log("qweqew"),r)return e.locals.usuario=void 0,e.status(401).json({message:"BAD USER"});e.locals.usuario=o,t()}))}else e.locals.usuario=void 0,t()}));const i=yield w().connect(e),a=((o,e)=>{const t=(0,y.Router)(),i=((o,e)=>({getColores:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().query("SELECT * FROM Color");return i.json(r.recordset)}catch(r){T(r,i,o,500)}})),insertarColor:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=t.body.color;yield e.request().input("hex_code",w().Char(6),r.hex_code).input("nombre",w().VarChar(20),r.nombre).execute("agregar_color"),i.json({mensaje:"Color Agregado"})}catch(r){T(r,i,o,500)}})),modificarColor:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=t.body.color;yield e.request().input("codColor",w().TinyInt,r.codColor).input("hex_code",w().Char(6),r.hex_code).input("nombre",w().VarChar(20),r.nombre).execute("modificar_color"),i.json({mensaje:"Color Modificado"})}catch(r){T(r,i,o,500)}})),getColor:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codColor",w().TinyInt,t.params.codColor).execute("get_color");return i.json(r.recordset[0])}catch(r){T(r,i,o,500)}})),insertarTrabajo:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=t.body.trabajo;if(!(r=>!!(r.pago&&r.pago>0)||!!(r.titulo&&r.titulo.length<=40))(r)){const r=new Error("Datos enviados incorrectos");return T(r,i,o,400)}const a=yield e.request().input("titulo",w().VarChar(40),r.titulo).input("pago",w().Decimal(19,4),r.pago).execute("insertar_trabajo");if(1!==a.recordset.length)return T(new Error("Error Al Insertar"),i,o,500);i.json(a.recordset[0])}catch(r){return T(r,i,o,500)}})),getMarcas:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().execute("get_marcas");i.json(r.recordset)}catch(r){return T(r,i,o,500)}})),getProveedores:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().execute("get_proveedores");return i.json(r.recordset||[])}catch(r){return T(r,i,o,500)}})),getDepartamentos:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().execute("listado_departamentos");return 0===r.recordset.length?T(new Error("No se encontraron departamentos"),i,o,401):i.json(r.recordset)}catch(r){return T(r,i,o,500)}})),getProvincias:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codDepartamento",w().VarChar(2),t.body.codDepartamento).execute("listado_provincias");return 0===r.recordset.length?T(new Error("No se encontraron provincias"),i,o,401):i.json(r.recordset)}catch(r){return T(r,i,o,500)}})),getDistritos:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codProvincia",w().VarChar(4),t.body.codProvincia).execute("listado_distritos");return 0===r.recordset.length?T(new Error("No se encontraron distritos"),i,o,401):i.json(r.recordset)}catch(r){return T(r,i,o,500)}})),getUnidadesDeMedida:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().execute("get_unidades_de_medida");return i.json(r.recordset)}catch(r){return T(r,i,o,500)}})),agregarMarca:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!t.body.nombre){const r=new Error("No se entrego un nombre");return T(r,i,o,500)}const r=yield e.request().input("nombre",w().VarChar(20),t.body.nombre).input("logo",w().VarChar(500),t.body.logo).input("info_extra",w().VarChar(w().MAX),t.body.info_extra).output("error",w().Int).output("codMarca",w().TinyInt).execute("add_marca");if(r.output.error){const r=new Error("Esta Marca Ya Existe");return T(r,i,o,500)}return i.json({codMarca:r.output.codMarca,nombre:t.body.nombre,logo:t.body.logo,info_extra:t.body.info_extra})}catch(r){return T(r,i,o,500)}}))}))(o,e);return t.get("/",((r,e)=>{o.log().info("Here"),e.send({mensaje:"Rutas de helpers"})})),t.get("/getUnidadesDeMedida",i.getUnidadesDeMedida),t.get("/getColores",i.getColores),t.get("/getProveedores",i.getProveedores),t.get("/getMarcas",i.getMarcas),t.get("/getColor/:codColor",i.getColor),t.post("/insertarColor",i.insertarColor),t.post("/modificarColor",i.modificarColor),t.post("/insertarTrabajo",i.insertarTrabajo),t.get("/getDepartamentos",i.getDepartamentos),t.post("/getProvincias",i.getProvincias),t.post("/getDistritos",i.getDistritos),t.post("/agregarMarca",i.agregarMarca),{router:t,ruta:"/helper"}})(o,i),n=((r,o)=>{const e=(0,y.Router)(),t=N(r,o);return e.get("/",((r,o)=>{o.send({mensaje:"Rutas de login"})})),e.post("/getUsuario",t.getUsuario),e.post("/darDeAltaUsuario",t.darDeAltaUsuario),e.post("/darDeBajaUsuario",t.darDeBajaUsuario),e.post("/reHabilitarUsuario",t.reHabilitarUsuario),e.post("/eliminarUsuario",t.eliminarUsuario),e.post("/registrar",t.adminLoginRequired,t.registrar),e.post("/usuarioExiste",t.usuarioExiste),e.post("/validarDNI",t.validarDNI),e.post("/login",t.comprobarUsuarioExisteLogin,t.comprobarContrasena,t.enviarTokenLogin),{router:e,ruta:"/auth"}})(o,i),d=((o,e)=>{const t=(0,y.Router)(),i=((o,e)=>({crearTipoMaterial:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!$(t.body.tipoNombre)){const r=new Error("Nombre Invalido");return B(r,i,o,400)}const r=yield e.request().input("nombre",w().VarChar(50),t.body.tipoNombre).output("error",w().Int).output("codTipoMaterial",w().SmallInt).execute("add_tipo_material");if(r.output.error){const e=new Error(2627===r.output.error?"Este nombre de tipo ya existe":`Error ${r.output.error}`);return B(e,i,o,400)}return i.json({message:"Tipo Añadido",nuevoTipo:{codTipoMaterial:r.output.codTipoMaterial,nombre:t.body.tipoNombre,deleted:!1}})}catch(r){return B(r,i,o,500)}})),getAllTipos:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codTipoMaterial",w().SmallInt,null).execute("get_tipo_material");return i.json(r.recordset)}catch(r){return B(r,i,o,500)}})),getTipo:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codTipoMaterial",w().SmallInt,t.params.codTipoMaterial).execute("get_tipo_material");if(0===r.recordsets[0].length){const r=new Error("Este tipo de material no existe");return B(r,i,o,404)}return i.json(Object.assign(Object.assign({},r.recordsets[0][0]),{subTipos:r.recordsets[1]||[]}))}catch(r){return B(r,i,o,500)}})),editarTipo:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!Q(t.body.codTipoMaterial,t.body.tipoNombre)){const r=new Error("Datos enviados incorrectamente");return B(r,i,o,400)}if(!$(t.body.tipoNombre)){const r=new Error("Nombre Invalido");return B(r,i,o,400)}if(!t.body.codTipoMaterial){const r=new Error("Codigo Invalido");return B(r,i,o,400)}const r=yield e.request().input("codTipoMaterial",w().SmallInt,t.body.codTipoMaterial).input("nombre",w().VarChar(50),t.body.tipoNombre).output("error",w().Int).execute("update_tipo_material");if(r.output.error){const e=new Error(2627===r.output.error?"Este nombre de tipo ya existe":`Error ${r.output.error}`);return B(e,i,o,400)}return i.json({message:"Tipo Actualizado",nuevoTipo:{codTipoMaterial:t.body.codTipoMaterial,nombre:t.body.tipoNombre,deleted:!1}})}catch(r){return B(r,i,o,500)}})),crearSubTipoMaterial:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!Q(t.body.subTipoNombre,t.body.codTipoMaterial)){const r=new Error("Datos enviados incorrectamente");return B(r,i,o,400)}if(!$(t.body.subTipoNombre)){const r=new Error("Nombre Invalido");return B(r,i,o,400)}const r=yield e.request().input("nombre",w().VarChar(50),t.body.subTipoNombre).input("codTipoMaterial",w().SmallInt,t.body.codTipoMaterial).output("error",w().Int).output("codSubTipoMaterial",w().SmallInt).execute("add_sub_tipo_material");if(r.output.error){const e=new Error(2627===r.output.error?"Este nombre de tipo ya existe":`Error ${r.output.error}`);return B(e,i,o,400)}return i.json({message:"Tipo Añadido",nuevoSubTipo:{codSubTipoMaterial:r.output.codSubTipoMaterial,nombre:t.body.subTipoNombre,deleted:!1}})}catch(r){return B(r,i,o,500)}})),getMaterial:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codMaterial",w().SmallInt,t.params.codMaterial).execute("get_material");if(0===r.recordsets[0].length){const r=new Error("Este material no existe");return B(r,i,o,404)}return i.json(Object.assign(Object.assign({},r.recordsets[0][0]),{variantes:r.recordsets[1]||[]}))}catch(r){return B(r,i,o,500)}})),crearMaterialFisico:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!Q(t.body.codMaterialDefinido,t.body.cantidad_original,t.body.cantidad_gastada,t.body.codProveedor,t.body.valor)){const r=new Error("Datos enviados incorrectamente");return B(r,i,o,400)}const r=yield e.request().input("codUsuario",w().Int,i.locals.usuario.aud.split(" ")[0]).input("codMaterialDefinido",w().Int,t.body.codMaterialDefinido).input("cantidad_original",w().Decimal(12,2),t.body.cantidad_original).input("cantidad_gastada",w().Decimal(12,2),t.body.cantidad_gastada).input("codProveedor",w().Int,t.body.codProveedor).input("valor",w().Decimal(19,4),t.body.valor).input("cod_factura",w().VarChar(15),t.body.cod_factura).input("comentario",w().VarChar(w().MAX),t.body.comentario).output("error",w().Int).output("codMaterialFisico",w().Int).output("codIngresoMaterial",w().Int).execute("agregar_material_fisico");if(r.output.error){const e=new Error(2627===r.output.error?"Este nombre de material ya existe":`Error ${r.output.error}`);return B(e,i,o,400)}return i.json({message:"Producto Material Añadido",nuevoProductoMaterial:r.recordset[0]})}catch(r){return B(r,i,o,500)}})),editarSubTipo:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!Q(t.body.subTipoNombre,t.body.codSubTipoMaterial)){const r=new Error("Datos enviados incorrectamente");return B(r,i,o,400)}if(!$(t.body.subTipoNombre)){const r=new Error("Nombre Invalido");return B(r,i,o,400)}if(!t.body.codSubTipoMaterial){const r=new Error("Codigo Invalido");return B(r,i,o,400)}const r=yield e.request().input("codSubTipoMaterial",w().SmallInt,t.body.codSubTipoMaterial).input("nombre",w().VarChar(50),t.body.subTipoNombre).output("error",w().Int).execute("update_sub_tipo_material");if(r.output.error){const e=new Error(2627===r.output.error?"Este nombre de tipo ya existe":`Error ${r.output.error}`);return B(e,i,o,400)}return i.json({message:"Tipo Actualizado",nuevoSubTipo:{codSubTipoMaterial:t.body.codSubTipoMaterial,nombre:t.body.subTipoNombre,deleted:!1}})}catch(r){return B(r,i,o,500)}})),getSubTipo:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codSubTipoMaterial",w().SmallInt,t.params.codSubTipoMaterial).execute("get_sub_tipo_material");if(0===r.recordsets[0].length){const r=new Error("Este sub tipo de material no existe");return B(r,i,o,404)}return i.json(Object.assign(Object.assign({},r.recordsets[0][0]),{materiales:r.recordsets[1]||[]}))}catch(r){return B(r,i,o,500)}})),crearMaterial:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!Q(t.body.nombreMaterial,t.body.codSubTipoMaterial,t.body.descripcion,t.body.unidad_medida,t.body.unidad_medida_uso)){const r=new Error("Datos enviados incorrectamente");return B(r,i,o,400)}if(!$(t.body.nombreMaterial)){const r=new Error("Nombre Invalido");return B(r,i,o,400)}const r=yield e.request().input("nombre",w().VarChar(80),t.body.nombreMaterial).input("codSubTipoMaterial",w().SmallInt,t.body.codSubTipoMaterial).input("descripcion",w().VarChar(w().MAX),t.body.descripcion).input("unidad_medida",w().VarChar(3),t.body.unidad_medida).input("unidad_medida_uso",w().VarChar(3),t.body.unidad_medida_uso).output("error",w().Int).output("codMaterial",w().Int).execute("add_material");if(r.output.error){const e=new Error(2627===r.output.error?"Este nombre de material ya existe":`Error ${r.output.error}`);return B(e,i,o,400)}return i.json({message:"Material Añadido",nuevoMaterial:{codMaterial:r.output.codMaterial,nombre:t.body.nombreMaterial,descripcion:t.body.descripcion,unidad_medida:t.body.unidad_medida,unidad_medida_uso:t.body.unidad_medida_uso,deleted:!1}})}catch(r){return B(r,i,o,500)}})),getVariantesMaterialFiltro:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codMaterial",w().Int,t.body.codMaterial).input("codColor",w().Int,t.body.codColor||null).input("codMarca",w().Int,t.body.codMarca||null).input("precioMin",w().Decimal(19,4),t.body.precioMin||null).input("precioMax",w().Decimal(19,4),t.body.precioMax||null).input("texto",w().VarChar(40),t.body.texto||null).execute("get_variantes_filtro");return i.json({variantes:r.recordsets[0]||[]})}catch(r){return B(r,i,o,500)}})),getMaterialFisicosFiltro:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codMaterialDefinido",w().Int,t.body.codMaterialDefinido).input("estado",w().TinyInt,t.body.estado||1).input("codProveedor",w().Int,-1==t.body.codProveedor?null:t.body.codProveedor).input("desde_fecha",w().Date,t.body.desde_fecha||null).input("hasta_fecha",w().Date,t.body.hasta_fecha||null).execute("get_material_fisico_filtro");return i.json({materialesFisicos:r.recordsets[0]||[]})}catch(r){return B(r,i,o,500)}})),editarMaterial:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!Q(t.body.nombreMaterial,t.body.codMaterial,t.body.descripcion,t.body.unidad_medida,t.body.unidad_medida_uso)){const r=new Error("Datos enviados incorrectamente");return B(r,i,o,400)}if(!$(t.body.nombreMaterial)){const r=new Error("Nombre Invalido");return B(r,i,o,400)}if(!t.body.codMaterial){const r=new Error("Codigo Invalido");return B(r,i,o,400)}const r=yield e.request().input("nombre",w().VarChar(80),t.body.nombreMaterial).input("descripcion",w().VarChar(w().MAX),t.body.descripcion).input("unidad_medida",w().VarChar(3),t.body.unidad_medida).input("unidad_medida_uso",w().VarChar(3),t.body.unidad_medida_uso).input("codMaterial",w().Int,t.body.codMaterial).output("error",w().Int).execute("update_material");if(r.output.error){const e=new Error(2627===r.output.error?"Este nombre de tipo ya existe":`Error ${r.output.error}`);return B(e,i,o,400)}return i.json({message:"Material Actualizado",nuevoMaterial:{codMaterial:t.body.codMaterial,nombre:t.body.nombreMaterial,descripcion:t.body.descripcion,unidad_medida:t.body.unidad_medida,unidad_medida_uso:t.body.unidad_medida_uso,deleted:!1}})}catch(r){return B(r,i,o,500)}})),crearMaterialDefinido:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!Q(t.body.nombre,t.body.codMaterial,t.body.codColor,t.body.codMarca,t.body.precio_por_unidad,t.body.descripcion)){const r=new Error("Datos enviados incorrectamente");return B(r,i,o,400)}const r=yield e.request().input("nombre",w().VarChar(50),t.body.nombre).input("codMaterial",w().SmallInt,t.body.codMaterial).input("codColor",w().TinyInt,t.body.codColor).input("codMarca",w().TinyInt,t.body.codMarca).input("precio_por_unidad",w().Decimal(19,4),t.body.precio_por_unidad).input("descripcion",w().VarChar(w().MAX),t.body.descripcion).input("colorNuevo",w().Bit,0==t.body.codColor).input("nombreColor",w().VarChar(20),t.body.nombreColor).input("hex_code",w().Char(6),t.body.hex_code).output("error",w().Int).output("codMaterialDefinido",w().Int).execute("add_material_definido");if(r.output.error){const e=new Error(2627===r.output.error?"Este nombre de material ya existe":`Error ${r.output.error}`);return B(e,i,o,400)}return i.json({message:"Variante Añadido",nuevaVariante:r.recordset[0]})}catch(r){return B(r,i,o,500)}})),editarMaterialDefinido:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{if(!Q(t.body.nombre,t.body.codMaterialDefinido,t.body.codColor,t.body.codMarca,t.body.precio_por_unidad,t.body.descripcion)){const r=new Error("Datos enviados incorrectamente");return B(r,i,o,400)}const r=yield e.request().input("nombre",w().VarChar(50),t.body.nombre).input("codMaterialDefinido",w().Int,t.body.codMaterialDefinido).input("codColor",w().TinyInt,t.body.codColor).input("codMarca",w().TinyInt,t.body.codMarca).input("precio_por_unidad",w().Decimal(19,4),t.body.precio_por_unidad).input("descripcion",w().VarChar(w().MAX),t.body.descripcion).input("colorNuevo",w().Bit,0==t.body.codColor).input("nombreColor",w().VarChar(20),t.body.nombreColor).input("hex_code",w().Char(6),t.body.hex_code).output("error",w().Int).execute("update_material_definido");if(r.output.error){const e=new Error(`Error ${r.output.error}`);return B(e,i,o,400)}if(!r.recordset[0]){const r=new Error("No se encontro la variacion");return B(r,i,o,400)}return i.json({message:"Variante Actualizada",nuevaVariante:r.recordset[0]})}catch(r){return B(r,i,o,500)}})),getMaterialDefinido:(t,i)=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{const r=yield e.request().input("codMaterialDefinido",w().SmallInt,t.params.codMaterialDefinido).execute("get_material_definido");if(0===r.recordsets[0].length){const r=new Error("Este material no existe");return B(r,i,o,404)}return i.json(Object.assign(Object.assign({},r.recordsets[0][0]),{materialesProductos:r.recordsets[1]||[]}))}catch(r){return B(r,i,o,500)}}))}))(o,e),a=N(o,e);return t.get("/",((r,o)=>{o.send({mensaje:"Rutas de materiales"})})),t.post("/getVariantesMaterialFiltro",i.getVariantesMaterialFiltro),t.post("/getMaterialFisicosFiltro",i.getMaterialFisicosFiltro),t.post("/crearTipoMaterial",i.crearTipoMaterial),t.post("/crearSubTipoMaterial",i.crearSubTipoMaterial),t.post("/editarSubTipo",i.editarSubTipo),t.post("/editarMaterial",i.editarMaterial),t.post("/crearMaterialDefinido",i.crearMaterialDefinido),t.post("/crearMaterialFisico",i.crearMaterialFisico),t.post("/editarMaterialDefinido",i.editarMaterialDefinido),t.post("/crearMaterial",i.crearMaterial),t.post("/editarTipo",i.editarTipo),t.get("/getAllTipos",a.loginRequired,i.getAllTipos),t.get("/getTipo/:codTipoMaterial",i.getTipo),t.get("/getMaterial/:codMaterial",i.getMaterial),t.get("/getSubTipo/:codSubTipoMaterial",i.getSubTipo),t.get("/getMaterialDefinido/:codMaterialDefinido",i.getMaterialDefinido),{router:t,ruta:"/materiales"}})(o,i);return t.use(a.ruta,a.router),t.use(n.ruta,n.router),t.use(d.ruta,d.router),t})),W=c.production,X=process.env.WEB_CONCURRENCY||1;a()({worker:o=>(0,r.__awaiter)(void 0,void 0,void 0,(function*(){try{W.log().info(`Id Worker ${o}`);const r=yield z(W);r.set("PORT",W.PORT||0);const e=t().createServer(r);e.listen(r.get("PORT")),e.on("listening",(()=>{W.log().info("http://localhost:"+e.address().port)}))}catch(r){W.log().error(r)}})),count:X})})()})();
//# sourceMappingURL=main.js.map